---
title: "UBC iGEM 2022 - Differential Expression Analysis"
output:
  html_document:
    df_print: paged
---
### Differential Expression Workflow:
1. Read in the Data
2. Create a DGEList Object
3. Filter
4. Normalize
5. Estimate Dispersions
6. Differential Expression
7. GO and Plant Reactome Enrichment

```{r, results='hide', message=FALSE, warning=FALSE}
library(tidyverse)
library(edgeR)
library(limma)
library(dplyr)
library(biomaRt)

x <- read.delim("../data/SRP045409_count.tsv.gz", row.names="gene")
x <- x %>% rename(HD_6h_1=SRR1542417, HD_6h_2=SRR1542416, HD_1h_1=SRR1542415, HD_1h_2=SRR1542414, H_6h_1=SRR1542413, H_6h_2=SRR1542412, H_1h_1=SRR1542411, H_1h_2=SRR1542410, D_6h_1=SRR1542409, D_6h_2=SRR1542408, D_1h_1=SRR1542407, D_1h_2=SRR1542406, ctrl_1=SRR1542405, ctrl_2=SRR1542404)

```

```{r}
# filter out LC (low confidence) genes
# https://plants.ensembl.org/Triticum_aestivum/Info/Annotation/
x <- x %>% filter(!grepl("LC", row.names(x), fixed=TRUE))

# round counts to nearest integer
x <- round(x)

d <- DGEList(counts=x, 
             group=factor(
               c("HD_6h", "HD_6h", "HD_1h", "HD_1h", "H_6h", "H_6h", "H_1h", "H_1h", "D_6h", "D_6h", "D_1h", "D_1h", "ctrl", "ctrl")))
d
```
```{r}
keep <- filterByExpr(d)
d <- d[keep, , keep.lib.sizes=FALSE]
d <- calcNormFactors(d)
d
```
```{r, results='hide', message=FALSE, warning=FALSE}
d <- estimateDisp(d)
```

As there are only a few samples, it's difficult to estimate the dispersion accurately for each gene, so we need a way of "sharing" information between genes. Possible solutions include:

- Using a common estimate across all genes (common dispersion).

- Fitting an estimate based on the mean-variance trend across the dataset, such that genes w/ similar abundances have similar variance estimates (trended dispersion).

- Computing a genewise dispersion (tagwise dispersion)

```{r}
plotBCV(d)
```

```{r}
et_HD6H_ctrl <- exactTest(d, pair=c("ctrl", "HD_6h"))
et_HD6H_ctrl$table$padj <- p.adjust(et_HD6H_ctrl$table$PValue, method="BH")
de <- decideTestsDGE(et_HD6H_ctrl, adjust.method="BH", p.value=0.001)
summary(de)
```


```{r}
detags <- rownames(d)[as.logical(de)] 
plotSmear(et_HD6H_ctrl, de.tags=detags)
abline(h = c(-2, 2), col = "blue")
```
```{r}
# up-regulated and down-regulated gene expression in HD_6h group compared to ctrl
sigReg <- et_HD6H_ctrl$table[et_HD6H_ctrl$table$padj<0.001,]
sigDownReg <- filter(sigReg, logFC < -5)
sigUpReg <- filter(sigReg, logFC > 5)
sigUpReg <- sigUpReg[order(sigUpReg$logFC,decreasing=TRUE), ]
sigDownReg <- sigDownReg[order(sigDownReg$logFC), ]
```

```{r}
eff.lib.size <- d$samples$lib.size*d$samples$norm.factors
normCounts <- cpm(d)
pseudoNormCounts <- log2(normCounts + 1)
boxplot(pseudoNormCounts, las=3)
```
```{r}
# plot based on multi-dimensional scaling
plotMDS(pseudoNormCounts)
```
```{r}
# HD6h vs. ctrl
volcanoData <- cbind(et_HD6H_ctrl$table$logFC, -log10(et_HD6H_ctrl$table$padj))
colnames(volcanoData) <- c("log2(FC)", "-log10(adjusted p-value)")
plot(volcanoData, cex=0.5)
abline(v=c(-2, 2), col="blue", lwd=3, lty=2)
abline(h=-log10(0.001), col="red", lwd=3, lty=2)
write.csv(et_HD6H_ctrl$table,"../data/HD6H_ctrl.csv", row.names = TRUE)
```
### Gene Ontology (GO), Plant Reactome, and KEGG Pathway Enrichment Analysis
```{r}
upRegGenes <- rownames(sigUpReg)
downRegGenes <- rownames(sigDownReg)
plantsDatabase <- useMart(biomart = 'plants_mart', dataset="taestivum_eg_gene", host = 'http://plants.ensembl.org')
```
```{r}
# BiomaRt provides reactome pathway and reaction IDs but mapping is required
pathways <- read.delim("../data/Ensembl2PlantReactome_PE_Pathway.txt", sep="\t")
pathways <- pathways %>% filter(pathways$Organism == "Triticum aestivum")
pathways <- subset(pathways, select = -c(Ensembl_ID, Pathway_ID, URL, unknown, Organism))
pathways
```
```{r}
# BiomaRt provides reactome pathway and reaction IDs but mapping is required
reactions <- read.delim("../data/Ensembl2PlantReactome_PE_Reactions.txt", sep="\t")
reactions <- reactions %>% filter(reactions$Organism == "Triticum aestivum")
reactions <- subset(reactions, select = -c(Ensembl_ID, Reaction_ID, URL, unknown, Organism))
reactions
```
```{r}
filters <- listFilters(plantsDatabase)
attributes <- listAttributes(plantsDatabase)
```
```{r, results='hide', message=FALSE, warning=FALSE}
# after filtering, LC (low confidence) genes are removed as they aren't present in the reference dataset
go_terms_upreg <- getBM(attributes = c("ensembl_gene_id", "description", "go_id", "name_1006", "definition_1006", "namespace_1003", "plant_reactome_pathway", "plant_reactome_reaction", "gene_biotype", "uniprotsptrembl"), filter = "ensembl_gene_id", values=upRegGenes, mart=plantsDatabase)
```

```{r, results='hide', message=FALSE, warning=FALSE}
upregMolFunc <- go_terms_upreg %>% filter(namespace_1003 == "molecular_function")
upregMolFunc <- upregMolFunc %>% distinct(ensembl_gene_id, name_1006, .keep_all = TRUE)
upRegMolFuncCounts <- upregMolFunc %>%
  group_by(name_1006) %>%
  summarise(n = n())

upRegMolFuncCounts <- slice_head(arrange(upRegMolFuncCounts, desc(n)), n=10)
upRegMolFuncCounts
```
```{r}
upRegMolFuncCounts$name_1006 = with(upRegMolFuncCounts, reorder(name_1006, n))

top10upRegMolFunc <- upRegMolFuncCounts %>%
ggplot(aes(x=name_1006, y=n, fill=name_1006, alpha=0.5)) + 
  geom_bar(stat = "identity", width=0.4) + coord_flip() +  labs(title = "Top 10 Molecular Function GO Terms", y = "# of Upregulated Genes in HD6h Wheat", x="") + theme(legend.position="none", plot.title = element_text(hjust = 0.5))

top10upRegMolFunc
```
```{r, results='hide', message=FALSE, warning=FALSE}
upregBioProc <- go_terms_upreg %>% filter(namespace_1003 == "biological_process")
upregBioProc <- upregBioProc %>% distinct(ensembl_gene_id, name_1006, .keep_all = TRUE)
upRegBioProcCounts <- upregBioProc %>%
  group_by(name_1006) %>%
  summarise(n = n())

upRegBioProcCounts <- slice_head(arrange(upRegBioProcCounts, desc(n)), n=10)
upRegBioProcCounts
```

```{r}
upRegBioProcCounts$name_1006 = with(upRegBioProcCounts, reorder(name_1006, n))

top10upRegBioProc <- upRegBioProcCounts %>%
ggplot(aes(x=name_1006, y=n, fill=name_1006, alpha=0.5)) + 
  geom_bar(stat = "identity", width=0.4) + coord_flip() +  labs(title = "Top 10 Biological Process GO Terms", y = "# of Upregulated Genes in HD6h Wheat", x = "") + theme(legend.position="none", plot.title = element_text(hjust=0.5))

top10upRegBioProc
```
```{r, results='hide', message=FALSE, warning=FALSE}
upregCellComp <- go_terms_upreg %>% filter(namespace_1003 == "cellular_component")
upregCellComp <- upregCellComp %>% distinct(ensembl_gene_id, name_1006, .keep_all = TRUE)
upRegCellCompCounts <- upregCellComp %>%
  group_by(name_1006) %>%
  summarise(n = n())

upRegCellCompCounts <- slice_head(arrange(upRegCellCompCounts, desc(n)), n=10)
upRegCellCompCounts
```
```{r}
upRegCellCompCounts$name_1006 = with(upRegCellCompCounts, reorder(name_1006, n))

top10upRegCellComp <- upRegCellCompCounts %>%
ggplot(aes(x=name_1006, y=n, fill=name_1006, alpha=0.5)) + 
  geom_bar(stat = "identity", width=0.4) + coord_flip() +  labs(title = "Top 10 Cellular Component GO Terms", y = "# of Upregulated Genes in HD6h Wheat", x = "") + theme(legend.position="none", plot.title= element_text(hjust=0.5))

top10upRegCellComp
```
```{r, results='hide', message=FALSE, warning=FALSE}
# after filtering, LC (low confidence) genes are removed as they aren't present in the reference dataset
go_terms_downreg <- getBM(attributes = c("ensembl_gene_id", "description", "go_id", "name_1006", "definition_1006", "namespace_1003", "plant_reactome_pathway", "plant_reactome_reaction", "gene_biotype", "uniprotsptrembl"), filter = "ensembl_gene_id", values=downRegGenes, mart=plantsDatabase)
```
```{r, results='hide', message=FALSE, warning=FALSE}
downregMolFunc <- go_terms_downreg %>% filter(namespace_1003 == "molecular_function")
downregMolFunc <- downregMolFunc %>% distinct(ensembl_gene_id, name_1006, .keep_all = TRUE)
downRegMolFuncCounts <- downregMolFunc %>%
  group_by(name_1006) %>%
  summarise(n = n())

downRegMolFuncCounts <- slice_head(arrange(downRegMolFuncCounts, desc(n)), n=10)
downRegMolFuncCounts
```
```{r}
downRegMolFuncCounts$name_1006 = with(downRegMolFuncCounts, reorder(name_1006, n))

top10downRegMolFunc <- downRegMolFuncCounts %>%
ggplot(aes(x=name_1006, y=n, fill=name_1006, alpha=0.5)) + 
  geom_bar(stat = "identity", width=0.4) + coord_flip() +  labs(title = "Top 10 Molecular Function GO Terms", y = "# of Downregulated Genes in HD6h Wheat", x = "") + theme(legend.position="none", plot.title=element_text(hjust=0.5))

top10downRegMolFunc
```
```{r, results='hide', message=FALSE, warning=FALSE}
downregBioProc <- go_terms_downreg %>% filter(namespace_1003 == "biological_process")
downregBioProc <- downregBioProc %>% distinct(ensembl_gene_id, name_1006, .keep_all = TRUE)
downRegBioProcCounts <- downregBioProc %>%
  group_by(name_1006) %>%
  summarise(n = n())

downRegBioProcCounts <- slice_head(arrange(downRegBioProcCounts, desc(n)), n=10)
downRegBioProcCounts
```

```{r}
downRegBioProcCounts$name_1006 = with(downRegBioProcCounts, reorder(name_1006, n))

top10downRegBioProc <- downRegBioProcCounts %>%
ggplot(aes(x=name_1006, y=n, fill=name_1006, alpha=0.5)) + 
  geom_bar(stat = "identity", width=0.4) + coord_flip() +  labs(title = "Top 10 Biological Process GO Terms", y = "# of Downregulated Genes in HD6h Wheat", x = "") + theme(legend.position="none", plot.title=element_text(hjust=0.5))

top10downRegBioProc
```
```{r, results='hide', message=FALSE, warning=FALSE}
downregCellComp <- go_terms_downreg %>% filter(namespace_1003 == "cellular_component")
downregCellComp <- downregCellComp %>% distinct(ensembl_gene_id, name_1006, .keep_all = TRUE)
downRegCellCompCounts <- downregCellComp %>%
  group_by(name_1006) %>%
  summarise(n = n())

downRegCellCompCounts <- slice_head(arrange(downRegCellCompCounts, desc(n)), n=10)
downRegCellCompCounts
```
```{r}
downRegCellCompCounts$name_1006 = with(downRegCellCompCounts, reorder(name_1006, n))

top10downRegCellComp <- downRegCellCompCounts %>%
ggplot(aes(x=name_1006, y=n, fill=name_1006, alpha=0.5)) + 
  geom_bar(stat = "identity", width=0.4) + coord_flip() +  labs(title = "Top 10 Cellular Componnet GO Terms", y = "# of Downregulated Genes in HD6h Wheat", x = "") + theme(legend.position="none", plot.title=element_text(hjust=0.5))

top10downRegCellComp
```
```{r}
upRegRxns <- go_terms_upreg %>% distinct(ensembl_gene_id, plant_reactome_reaction, .keep_all = TRUE)
upRegRxns <- merge(x=upRegRxns, y=reactions, by="plant_reactome_reaction", all=FALSE)
upRegRxnsCounts <- upRegRxns %>%
  group_by(Rxn_Name) %>%
  summarise(n = n())

upRegRxnsCounts <- slice_head(arrange(upRegRxnsCounts, desc(n)), n=30)
upRegRxnsCounts
```
```{r}
downRegRxns <- go_terms_downreg %>% distinct(ensembl_gene_id, plant_reactome_reaction, .keep_all = TRUE)
downRegRxns <- merge(x=downRegRxns, y=reactions, by="plant_reactome_reaction", all=FALSE)
downRegRxnsCounts <- downRegRxns %>%
  group_by(Rxn_Name) %>%
  summarise(n = n())

downRegRxnsCounts <- slice_head(arrange(downRegRxnsCounts, desc(n)), n=30)
downRegRxnsCounts
```
```{r}
upRegPathways <- go_terms_upreg %>% distinct(ensembl_gene_id, plant_reactome_pathway, .keep_all = TRUE)
upRegPathways <- merge(x=upRegPathways, y=pathways, by="plant_reactome_pathway", all=FALSE)
upRegPathwaysCounts <- upRegPathways %>%
  group_by(Pathway_Name) %>%
  summarise(n = n())

upRegPathwaysCounts <- slice_head(arrange(upRegPathwaysCounts, desc(n)), n=30)
upRegPathwaysCounts
```
```{r}
downRegPathways <- go_terms_downreg %>% distinct(ensembl_gene_id, plant_reactome_pathway, .keep_all = TRUE)
downRegPathways <- merge(x=downRegPathways, y=pathways, by="plant_reactome_pathway", all=FALSE)
downRegPathwaysCounts <- downRegPathways %>%
  group_by(Pathway_Name) %>%
  summarise(n = n())

downRegPathwaysCounts <- slice_head(arrange(downRegPathwaysCounts, desc(n)), n=30)
downRegPathwaysCounts
```

